Все правки к коду указаны в комментариях в коде. 
